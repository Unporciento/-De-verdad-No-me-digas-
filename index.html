<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IG ANALYTICS [ULTIMATE_CORE]</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --surface: #111; --primary: #c13584; --text: #e0e0e0; --danger: #ff3b30; --success: #34c759; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        header { position: sticky; top: 0; z-index: 100; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 15px; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 18px; background: linear-gradient(45deg, #f09433, #dc2743, #bc1888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .upload-section { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .btn-box { background: var(--surface); border: 1px solid #333; padding: 20px; border-radius: 12px; text-align: center; position: relative; overflow: hidden; }
        .btn-box h3 { margin: 0 0 5px 0; font-size: 14px; }
        .btn-box p { margin: 0; font-size: 11px; color: #666; }
        input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid #222; }
        .card.full { grid-column: span 2; }
        .stat-val { font-size: 24px; font-weight: 800; color: #fff; }
        .stat-lbl { font-size: 11px; color: #888; text-transform: uppercase; }
        
        .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 10px 15px; }
        .tab { padding: 8px 16px; background: #222; border-radius: 20px; font-size: 13px; white-space: nowrap; }
        .tab.active { background: var(--text); color: #000; }

        .list-item { padding: 12px 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 14px; }
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; place-items: center; z-index: 999; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header><h1>IG DATA ANALYZER PRO</h1></header>

<div id="loading"><div><div class="spinner"></div><div id="status">Procesando...</div></div></div>

<div id="upload-ui" class="upload-section">
    <div class="btn-box">
        <h3>üì¶ SUBIR ARCHIVO .ZIP</h3>
        <p>Selecciona el ZIP sin descomprimir</p>
        <input type="file" id="zipInput" accept=".zip">
    </div>
    <div style="text-align:center; color:#444; font-size:12px;">‚Äî O ‚Äî</div>
    <div class="btn-box">
        <h3>üìÇ SELECCIONAR CARPETA</h3>
        <p>Si ya lo descomprimiste (iOS Archivos)</p>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="tabs">
        <div class="tab active" onclick="view('dash')">Resumen</div>
        <div class="tab" onclick="view('traitors')">No te siguen</div>
        <div class="tab" onclick="view('fans')">Fans</div>
        <div class="tab" onclick="view('chats')">Ranking Chats</div>
    </div>

    <div id="v-dash">
        <div class="grid" id="stats"></div>
        <div class="card full" style="margin:0 10px;"><canvas id="chart"></canvas></div>
    </div>
    <div id="v-traitors" style="display:none"></div>
    <div id="v-fans" style="display:none"></div>
    <div id="v-chats" style="display:none"></div>
</div>

<script>
const S = { followers: new Set(), following: new Set(), chats: {}, hours: Array(24).fill(0) };
const UI = { 
    zip: document.getElementById('zipInput'), 
    folder: document.getElementById('folderInput'),
    app: document.getElementById('app'), 
    load: document.getElementById('loading'), 
    status: document.getElementById('status'),
    ui: document.getElementById('upload-ui')
};

// EVENTOS
UI.zip.addEventListener('change', async e => handleFiles(e.target.files, true));
UI.folder.addEventListener('change', async e => handleFiles(e.target.files, false));

async function handleFiles(files, isZip) {
    UI.load.style.display = 'grid';
    resetS();

    if (isZip) {
        const zip = await JSZip.loadAsync(files[0]);
        const allFiles = Object.keys(zip.files).filter(n => n.endsWith('.json'));
        for (let path of allFiles) {
            if (isRelevant(path)) {
                const txt = await zip.file(path).async('string');
                processData(JSON.parse(txt), path);
            }
        }
    } else {
        for (let file of files) {
            if (file.name.endsWith('.json') && isRelevant(file.webkitRelativePath)) {
                const txt = await file.text();
                processData(JSON.parse(txt), file.webkitRelativePath);
            }
        }
    }
    
    render();
    UI.load.style.display = 'none';
    UI.ui.style.display = 'none';
    UI.app.style.display = 'block';
}

function isRelevant(p) { return p.includes('follower') || p.includes('following') || p.includes('message'); }

function processData(data, path) {
    const isFoll = path.includes('follower');
    const isFing = path.includes('following');

    if (isFoll || isFing) {
        // Soporte para formato Meta 2024/2025/2026
        const list = Array.isArray(data) ? data : (data.relationships_followers || data.relationships_following || []);
        list.forEach(item => {
            if (item.string_list_data) {
                item.string_list_data.forEach(s => {
                    if(isFoll) S.followers.add(s.value);
                    if(isFing) S.following.add(s.value);
                });
            }
        });
    }

    if (data.messages) {
        data.messages.forEach(m => {
            if (m.sender_name) {
                S.chats[m.sender_name] = (S.chats[m.sender_name] || 0) + 1;
                if (m.timestamp_ms) S.hours[new Date(m.timestamp_ms).getHours()]++;
            }
        });
    }
}

function render() {
    const t = [...S.following].filter(x => !S.followers.has(x));
    const f = [...S.followers].filter(x => !S.following.has(x));
    document.getElementById('stats').innerHTML = `
        <div class="card"><div class="stat-lbl">Seguidores</div><div class="stat-val">${S.followers.size}</div></div>
        <div class="card"><div class="stat-lbl">Siguiendo</div><div class="stat-val">${S.following.size}</div></div>
        <div class="card"><div class="stat-lbl">No devuelven ‚ùå</div><div class="stat-val" style="color:var(--danger)">${t.length}</div></div>
        <div class="card"><div class="stat-lbl">Fans (T√∫ no sigues)</div><div class="stat-val" style="color:var(--success)">${f.length}</div></div>
    `;
    fill('v-traitors', t);
    fill('v-fans', f);
    const cSorted = Object.entries(S.chats).sort((a,b)=>b[1]-a[1]).map(([n,c])=>`<div class="list-item"><span>${n}</span><span>${c} msgs</span></div>`).join('');
    document.getElementById('v-chats').innerHTML = cSorted;

    new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels: [...Array(24).keys()].map(h=>h+'h'), datasets: [{ label:'Actividad', data: S.hours, borderColor: '#c13584', tension: 0.4 }] },
        options: { plugins: { legend: false }, scales: { y: { display: false } } }
    });
}

function fill(id, arr) { document.getElementById(id).innerHTML = arr.map(u => `<div class="list-item"><span>${u}</span></div>`).join(''); }
function resetS() { S.followers.clear(); S.following.clear(); S.chats = {}; S.hours.fill(0); }
function view(id) {
    ['dash','traitors','fans','chats'].forEach(x => document.getElementById('v-'+x).style.display = 'none');
    document.getElementById('v-'+id).style.display = 'block';
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
}
</script>
</body>
</html>
