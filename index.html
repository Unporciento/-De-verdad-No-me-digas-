<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IG ANALYTICS V4 [IPHONE FIX]</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --card: #111; --primary: #ff3366; --text: #eee; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
        header { padding: 20px; text-align: center; border-bottom: 1px solid #333; }
        .main-btn { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px; position: relative; font-weight: bold; }
        input[type=file] { position: absolute; inset: 0; opacity: 0; width: 100%; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #222; }
        .val { font-size: 24px; font-weight: 800; display: block; }
        .lbl { font-size: 10px; color: #888; text-transform: uppercase; }

        #log { font-size: 11px; color: #00ff88; padding: 0 20px; font-family: monospace; }
        .list { padding: 15px; display: none; }
        .item { padding: 10px 0; border-bottom: 1px solid #222; font-size: 14px; display: flex; justify-content: space-between; }
        
        .tabs { display: flex; gap: 10px; padding: 0 15px; overflow-x: auto; }
        .tab { padding: 8px 15px; background: #222; border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .tab.active { background: #fff; color: #000; }
    </style>
</head>
<body>

<header><h1 style="font-size:18px; color:var(--primary); margin:0;">IG ANALYTICS V4</h1></header>

<div id="ui-upload">
    <div class="main-btn">
        üöÄ TOCAR PARA CARGAR DATA
        <p style="font-size:10px; margin:5px 0 0; font-weight:normal; opacity:0.8;">Puedes subir el ZIP o seleccionar varios JSON</p>
        <input type="file" id="filePicker" multiple accept=".json,.zip">
    </div>
    <div id="log">Esperando archivos...</div>
</div>

<div id="dashboard" style="display:none">
    <div class="stats">
        <div class="stat-card"><span class="lbl">Seguidores</span><span id="s1" class="val">0</span></div>
        <div class="stat-card"><span class="lbl">Siguiendo</span><span id="s2" class="val">0</span></div>
        <div class="stat-card"><span class="lbl">No te siguen</span><span id="s3" class="val" style="color:var(--primary)">0</span></div>
        <div class="stat-card"><span class="lbl">Fans</span><span id="s4" class="val" style="color:00ff88">0</span></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="tab('dash')">Actividad</div>
        <div class="tab" onclick="tab('traitors')">No te siguen</div>
        <div class="tab" onclick="tab('chats')">Ranking Chats</div>
    </div>

    <div id="v-dash" class="list" style="display:block">
        <canvas id="chart" style="max-height: 200px;"></canvas>
    </div>
    <div id="v-traitors" class="list"></div>
    <div id="v-chats" class="list"></div>
</div>

<script>
const STORE = { followers: new Set(), following: new Set(), chats: {}, hours: Array(24).fill(0) };
const picker = document.getElementById('filePicker');
const log = document.getElementById('log');

picker.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    log.innerText = `Procesando ${files.length} archivo(s)...`;
    
    for (const f of files) {
        if (f.name.endsWith('.zip')) {
            try {
                const zip = await JSZip.loadAsync(f);
                const jsons = Object.keys(zip.files).filter(n => n.endsWith('.json'));
                for (const path of jsons) {
                    const txt = await zip.file(path).async("string");
                    parse(JSON.parse(txt), path);
                }
            } catch (err) { log.innerText = "Error en ZIP: " + err; }
        } else if (f.name.endsWith('.json')) {
            const txt = await f.text();
            parse(JSON.parse(txt), f.name);
        }
    }

    render();
    document.getElementById('ui-upload').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
});

function parse(data, name) {
    const n = name.toLowerCase();
    
    // Funci√≥n extractora universal (recorre todo el JSON buscando nombres)
    const extract = (obj, targetSet) => {
        if (!obj || typeof obj !== 'object') return;
        if (obj.string_list_data) {
            obj.string_list_data.forEach(item => {
                if (item.value) targetSet.add(decodeURIComponent(escape(item.value)));
            });
        }
        Object.values(obj).forEach(v => extract(v, targetSet));
    };

    if (n.includes('follower')) extract(data, STORE.followers);
    if (n.includes('following')) extract(data, STORE.following);

    if (data.messages && Array.isArray(data.messages)) {
        data.messages.forEach(m => {
            if (m.sender_name) {
                const sn = decodeURIComponent(escape(m.sender_name));
                STORE.chats[sn] = (STORE.chats[sn] || 0) + 1;
                if (m.timestamp_ms) STORE.hours[new Date(m.timestamp_ms).getHours()]++;
            }
        });
    }
}

function render() {
    const t = [...STORE.following].filter(x => !STORE.followers.has(x));
    const f = [...STORE.followers].filter(x => !STORE.following.has(x));

    document.getElementById('s1').innerText = STORE.followers.size;
    document.getElementById('s2').innerText = STORE.following.size;
    document.getElementById('s3').innerText = t.length;
    document.getElementById('s4').innerText = f.size;

    document.getElementById('v-traitors').innerHTML = t.map(u => `<div class="item"><span>${u}</span> <span style="color:#ff3366">‚ùå</span></div>`).join('');
    
    const sortedChats = Object.entries(STORE.chats).sort((a,b) => b[1] - a[1]);
    document.getElementById('v-chats').innerHTML = sortedChats.map(([n, c]) => `<div class="item"><span>${n}</span> <span>${c} msgs</span></div>`).join('');

    new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
            labels: [...Array(24).keys()].map(h => h+'h'),
            datasets: [{ label: 'Mensajes', data: STORE.hours, backgroundColor: '#ff3366' }]
        },
        options: { plugins: { legend: false }, scales: { y: { display: false } } }
    });
}

function tab(name) {
    document.querySelectorAll('.list').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById('v-' + name).style.display = 'block';
    event.target.classList.add('active');
}
</script>
</body>
</html>
