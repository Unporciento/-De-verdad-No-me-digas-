<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IG MEGA-ANALYZER V6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #000; --card: #121212; --primary: #00f2ff; --accent: #7000ff; --text: #ffffff; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
        header { padding: 25px 15px; background: linear-gradient(to bottom, #1a1a1a, #000); border-bottom: 1px solid #333; text-align: center; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }
        
        /* Dropzone & Inputs */
        .upload-container { padding: 20px; }
        .dropzone { border: 2px dashed #444; border-radius: 20px; padding: 40px 20px; text-align: center; background: var(--card); position: relative; transition: 0.3s; }
        .dropzone:active { border-color: var(--primary); background: #1a1a1a; }
        input[type=file] { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .stat-card { background: var(--card); padding: 18px; border-radius: 16px; border: 1px solid #222; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .val { font-size: 32px; font-weight: 900; display: block; margin-bottom: 5px; }
        .lbl { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* Tabs & Lists */
        .tabs { display: flex; gap: 10px; padding: 10px 15px; overflow-x: auto; background: #000; position: sticky; top: 75px; z-index: 90; }
        .tab { padding: 10px 20px; background: #1a1a1a; border-radius: 25px; font-size: 12px; white-space: nowrap; border: 1px solid #333; cursor: pointer; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; border-color: var(--primary); }

        .list-view { display: none; padding: 15px; }
        .user-row { padding: 14px; background: #0a0a0a; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1a1a1a; }
        .tag { font-size: 9px; padding: 3px 8px; border-radius: 5px; font-weight: bold; text-transform: uppercase; }

        /* Progress Bar */
        #progress-container { display: none; padding: 0 20px 20px; }
        .progress-bg { background: #222; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: 0.1s; box-shadow: 0 0 10px var(--primary); }
        #status-msg { font-size: 10px; color: #888; margin-top: 8px; text-align: center; font-family: monospace; }
        
        canvas { max-height: 220px; margin-top: 15px; }
    </style>
</head>
<body>

<header>
    <h1>META ANALYZER <span style="font-weight: 300; opacity: 0.6;">V6.0</span></h1>
</header>

<div id="upload-screen">
    <div class="upload-container">
        <div class="dropzone">
            <div style="font-size: 40px; margin-bottom: 15px;">üíæ</div>
            <div style="font-weight: bold;">SELECCIONAR DATA (0.5GB+)</div>
            <div style="font-size: 11px; color: #666; margin-top: 8px;">Sube el ZIP o selecciona archivos JSON de Drive</div>
            <input type="file" id="megaInput" multiple accept=".json,.zip">
        </div>
    </div>
    
    <div id="progress-container">
        <div class="progress-bg"><div class="progress-fill" id="p-fill"></div></div>
        <div id="status-msg">Iniciando motor de an√°lisis...</div>
    </div>
</div>

<div id="dashboard" style="display:none">
    <div class="stats-grid">
        <div class="stat-card">
            <span class="lbl">Seguidores</span><span id="res-foll" class="val">0</span>
        </div>
        <div class="stat-card">
            <span class="lbl">Siguiendo</span><span id="res-fing" class="val">0</span>
        </div>
        <div class="stat-card" style="border-color: #ff0055;">
            <span class="lbl">No te siguen</span><span id="res-tra" class="val" style="color: #ff0055;">0</span>
        </div>
        <div class="stat-card" style="border-color: #00ff88;">
            <span class="lbl">Fans</span><span id="res-fans" class="val" style="color: #00ff88;">0</span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="nav('overview')">Gr√°ficos</div>
        <div class="tab" onclick="nav('traitors')">Traidores ‚ùå</div>
        <div class="tab" onclick="nav('fans')">Fans (T√∫ no sigues)</div>
        <div class="tab" onclick="nav('ranking')">Top Chats üí¨</div>
    </div>

    <div id="v-overview" class="list-view" style="display:block">
        <div class="stat-card" style="width: 100%; border: none; background: #080808;">
            <span class="lbl">Actividad horaria (24h)</span>
            <canvas id="timeChart"></canvas>
        </div>
    </div>

    <div id="v-traitors" class="list-view"></div>
    <div id="v-fans" class="list-view"></div>
    <div id="v-ranking" class="list-view"></div>
</div>

<script>
// CONFIGURACI√ìN DE ESTADO GLOBAL
const DATA = {
    followers: new Set(),
    following: new Set(),
    chats: {},
    hourly: Array(24).fill(0),
    filesTotal: 0,
    filesDone: 0
};

const UI = {
    input: document.getElementById('megaInput'),
    pBar: document.getElementById('p-fill'),
    pCont: document.getElementById('progress-container'),
    msg: document.getElementById('status-msg'),
    dash: document.getElementById('dashboard'),
    upScreen: document.getElementById('upload-screen')
};

UI.input.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    UI.pCont.style.display = 'block';
    DATA.filesTotal = files.length;

    // MOTOR DE PROCESAMIENTO
    for (const file of files) {
        UI.msg.innerText = `Analizando: ${file.name}`;
        
        if (file.name.endsWith('.zip')) {
            try {
                const zip = await JSZip.loadAsync(file);
                const entries = Object.keys(zip.files).filter(n => n.endsWith('.json'));
                DATA.filesTotal += entries.length;
                
                for (const path of entries) {
                    const txt = await zip.file(path).async("string");
                    process(JSON.parse(txt), path);
                    updateProgress();
                }
            } catch (err) { console.error("Error ZIP:", err); }
        } else if (file.name.endsWith('.json')) {
            const txt = await file.text();
            process(JSON.parse(txt), file.name);
            updateProgress();
        }
    }

    renderUI();
});

function process(json, fileName) {
    const name = fileName.toLowerCase();
    
    // MEJORA CHATGPT: Extracci√≥n profunda de nombres (string_list_data)
    const harvest = (obj, targetSet) => {
        if (!obj || typeof obj !== 'object') return;
        if (obj.string_list_data) {
            obj.string_list_data.forEach(item => {
                if (item.value) targetSet.add(decodeURIComponent(escape(item.value)));
            });
        }
        Object.values(obj).forEach(v => harvest(v, targetSet));
    };

    if (name.includes('follower')) harvest(json, DATA.followers);
    if (name.includes('following')) harvest(json, DATA.following);

    // MEJORA GEMINI: Mensajes y Actividad
    if (json.messages && Array.isArray(json.messages)) {
        json.messages.forEach(m => {
            if (m.sender_name) {
                const user = decodeURIComponent(escape(m.sender_name));
                DATA.chats[user] = (DATA.chats[user] || 0) + 1;
                if (m.timestamp_ms) {
                    const h = new Date(m.timestamp_ms).getHours();
                    DATA.hourly[h]++;
                }
            }
        });
    }
}

function updateProgress() {
    DATA.filesDone++;
    const perc = (DATA.filesDone / DATA.filesTotal) * 100;
    UI.pBar.style.width = `${perc}%`;
}

function renderUI() {
    const traitors = [...DATA.following].filter(x => !DATA.followers.has(x));
    const fans = [...DATA.followers].filter(x => !DATA.following.has(x));

    document.getElementById('res-foll').innerText = DATA.followers.size;
    document.getElementById('res-fing').innerText = DATA.following.size;
    document.getElementById('res-tra').innerText = traitors.length;
    document.getElementById('res-fans').innerText = fans.length;

    // RENDERIZADO DE LISTAS
    document.getElementById('v-traitors').innerHTML = traitors.map(u => 
        `<div class="user-row"><span>${u}</span><span class="tag" style="background:#ff00551a; color:#ff0055;">No sigue</span></div>`).join('');
    
    document.getElementById('v-fans').innerHTML = fans.map(u => 
        `<div class="user-row"><span>${u}</span><span class="tag" style="background:#00ff881a; color:#00ff88;">Fan</span></div>`).join('');

    const chats = Object.entries(DATA.chats).sort((a,b) => b[1] - a[1]);
    document.getElementById('v-ranking').innerHTML = chats.map(([n, c]) => 
        `<div class="user-row"><span>${n}</span><b style="color:var(--primary)">${c} msgs</b></div>`).join('');

    // CHART
    new Chart(document.getElementById('timeChart'), {
        type: 'line',
        data: {
            labels: [...Array(24).keys()].map(h => h+'h'),
            datasets: [{ 
                label: 'Interacci√≥n', 
                data: DATA.hourly, 
                borderColor: '#00f2ff', 
                tension: 0.4, 
                fill: true,
                backgroundColor: 'rgba(0, 242, 255, 0.05)'
            }]
        },
        options: { plugins: { legend: false }, scales: { y: { display: false }, x: { grid: { color: '#222' } } } }
    });

    UI.upScreen.style.display = 'none';
    UI.dash.style.display = 'block';
}

function nav(id) {
    document.querySelectorAll('.list-view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('v-' + id).style.display = 'block';
    event.currentTarget.classList.add('active');
}
</script>
</body>
</html>
