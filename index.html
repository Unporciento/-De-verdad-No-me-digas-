<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IG ANALYTICS V3 [DEBUG_MODE]</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #050505; --surface: #121212; --primary: #ff3366; --text: #f0f0f0; --success: #00ff88; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
        header { padding: 15px; background: #000; border-bottom: 1px solid #333; text-align: center; }
        h1 { margin: 0; font-size: 16px; color: var(--primary); letter-spacing: 1px; }
        
        .upload-area { padding: 20px; }
        .box { background: var(--surface); border: 2px dashed #444; border-radius: 15px; padding: 40px 20px; text-align: center; position: relative; }
        input[type=file] { position: absolute; inset: 0; opacity: 0; }
        
        #debug-log { font-size: 10px; color: #666; padding: 10px; font-family: monospace; max-height: 60px; overflow: hidden; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid #222; }
        .val { font-size: 26px; font-weight: bold; display: block; }
        .lbl { font-size: 10px; color: #888; text-transform: uppercase; }

        .tabs { display: flex; gap: 10px; overflow-x: auto; padding: 0 15px 10px; }
        .tab { padding: 8px 15px; background: #222; border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .tab.active { background: #fff; color: #000; }

        .list-view { padding: 0 15px; display: none; }
        .item { padding: 12px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 14px; }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; place-items: center; z-index: 1000; }
        .spin { width: 30px; height: 30px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: s 1s infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header><h1>IG DATA ANALYZER V3</h1></header>

<div id="loader"><div><div class="spin"></div><p id="l-msg">Procesando...</p></div></div>

<div id="setup">
    <div class="upload-area">
        <div class="box">
            <p>üìÅ SELECCIONA TU ZIP O CARPETA</p>
            <span style="font-size: 10px; color: #888;">(Exportaci√≥n de Instagram 2024-2026)</span>
            <input type="file" id="mainInput" webkitdirectory directory multiple>
        </div>
    </div>
    <div id="debug-log">Esperando archivos...</div>
</div>

<div id="dashboard" style="display:none">
    <div class="stats-grid">
        <div class="stat-card"><span class="lbl">Seguidores</span><span id="c-foll" class="val">0</span></div>
        <div class="stat-card"><span class="lbl">Siguiendo</span><span id="c-fing" class="val">0</span></div>
        <div class="stat-card"><span class="lbl">No te siguen</span><span id="c-tra" class="val" style="color:var(--primary)">0</span></div>
        <div class="stat-card"><span class="lbl">Fans</span><span id="c-fans" class="val" style="color:var(--success)">0</span></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="show('dash')">Resumen</div>
        <div class="tab" onclick="show('tra')">No te siguen</div>
        <div class="tab" onclick="show('chats')">Top Chats</div>
    </div>

    <div id="v-dash" class="list-view" style="display:block">
        <div class="stat-card" style="margin-top:10px"><canvas id="chart"></canvas></div>
    </div>
    <div id="v-tra" class="list-view"></div>
    <div id="v-chats" class="list-view"></div>
</div>

<script>
const DATA = { followers: new Set(), following: new Set(), messages: {}, timeline: Array(24).fill(0) };
const UI = {
    input: document.getElementById('mainInput'),
    loader: document.getElementById('loader'),
    log: document.getElementById('debug-log'),
    setup: document.getElementById('setup'),
    dash: document.getElementById('dashboard')
};

UI.input.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (!files.length) return;
    
    UI.loader.style.display = 'grid';
    
    // Si es un solo archivo y es ZIP
    if (files.length === 1 && files[0].name.endsWith('.zip')) {
        UI.log.innerText = "Abriendo ZIP...";
        try {
            const zip = await JSZip.loadAsync(files[0]);
            const entries = Object.keys(zip.files).filter(f => f.endsWith('.json'));
            for (let path of entries) {
                const content = await zip.file(path).async("string");
                parseJson(JSON.parse(content), path);
            }
        } catch (err) { alert("Error con el ZIP: " + err); }
    } else {
        // Si es selecci√≥n de carpeta
        for (let f of files) {
            if (f.name.endsWith('.json')) {
                const text = await f.text();
                parseJson(JSON.parse(text), f.webkitRelativePath || f.name);
            }
        }
    }

    render();
    UI.loader.style.display = 'none';
    UI.setup.style.display = 'none';
    UI.dash.style.display = 'block';
});

function parseJson(json, path) {
    const p = path.toLowerCase();
    
    // CAZADOR DE SEGUIDORES / SIGUIENDO
    if (p.includes('follower') || p.includes('following')) {
        UI.log.innerText = "Analizando: " + p;
        const target = p.includes('follower') ? DATA.followers : DATA.following;
        
        // Buscamos 'string_list_data' en cualquier estructura (Meta 2026)
        const findNames = (obj) => {
            if (!obj || typeof obj !== 'object') return;
            if (obj.string_list_data && Array.isArray(obj.string_list_data)) {
                obj.string_list_data.forEach(entry => {
                    if (entry.value) target.add(decodeURIComponent(escape(entry.value)));
                });
            }
            Object.values(obj).forEach(val => findNames(val));
        };
        findNames(json);
    }

    // CAZADOR DE MENSAJES
    if (p.includes('message') || p.includes('inbox')) {
        if (json.messages && Array.isArray(json.messages)) {
            json.messages.forEach(m => {
                if (m.sender_name) {
                    const name = decodeURIComponent(escape(m.sender_name));
                    DATA.messages[name] = (DATA.messages[name] || 0) + 1;
                    if (m.timestamp_ms) {
                        const h = new Date(m.timestamp_ms).getHours();
                        DATA.timeline[h]++;
                    }
                }
            });
        }
    }
}

function render() {
    const traitors = [...DATA.following].filter(x => !DATA.followers.has(x));
    const fans = [...DATA.followers].filter(x => !DATA.following.has(x));

    document.getElementById('c-foll').innerText = DATA.followers.size;
    document.getElementById('c-fing').innerText = DATA.following.size;
    document.getElementById('c-tra').innerText = traitors.length;
    document.getElementById('c-fans').innerText = fans.length;

    document.getElementById('v-tra').innerHTML = traitors.map(u => `<div class="item"><span>${u}</span> <span style="color:#f36">PERFIL</span></div>`).join('');
    
    const chats = Object.entries(DATA.messages).sort((a,b) => b[1] - a[1]);
    document.getElementById('v-chats').innerHTML = chats.map(([n, c]) => `<div class="item"><span>${n}</span> <span>${c} msgs</span></div>`).join('');

    new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
            labels: [...Array(24).keys()].map(h => h+'h'),
            datasets: [{ label: 'Actividad', data: DATA.timeline, backgroundColor: '#ff3366' }]
        },
        options: { plugins: { legend: false }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });
}

function show(v) {
    document.querySelectorAll('.list-view').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById('v-' + v).style.display = 'block';
    event.target.classList.add('active');
}
</script>
</body>
</html>
