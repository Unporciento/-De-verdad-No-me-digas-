<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instagram Data Overkill</title>

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b0b0b;
    color: #fff;
}
header {
    padding: 15px;
    text-align: center;
    font-weight: 700;
    background: #111;
    border-bottom: 1px solid #222;
}
input, button {
    width: 100%;
    padding: 14px;
    background: #1a1a1a;
    border: none;
    color: #fff;
    font-size: 16px;
}
button {
    background: #3897f0;
    border-radius: 10px;
    margin-top: 10px;
}
section {
    padding: 15px;
}
.card {
    background: #1b1b1b;
    border-radius: 14px;
    padding: 15px;
    margin-bottom: 12px;
}
.title {
    font-weight: 600;
    margin-bottom: 8px;
}
.small {
    font-size: 13px;
    opacity: .7;
}
.row {
    display: flex;
    justify-content: space-between;
}
.chat {
    border-bottom: 1px solid #333;
    padding: 6px 0;
}
.hidden {
    display: none;
}
</style>
</head>

<body>

<header>üß† Instagram Data Overkill</header>

<input type="file" id="files" multiple accept=".json">
<input type="search" id="search" placeholder="üîç Buscar en TODO">

<section id="dashboard"></section>
<section id="lists"></section>
<section id="chats"></section>

<script>
const dashboard = document.getElementById("dashboard");
const lists = document.getElementById("lists");
const chatsEl = document.getElementById("chats");
const searchInput = document.getElementById("search");

let followers = new Set();
let following = new Set();
let chatStats = {};
let messagesTimeline = [];

document.getElementById("files").addEventListener("change", e => {
    reset();
    [...e.target.files].forEach(f => loadFile(f));
});

searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    document.querySelectorAll(".searchable").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q)
            ? "block" : "none";
    });
});

function reset() {
    followers.clear();
    following.clear();
    chatStats = {};
    messagesTimeline = [];
    dashboard.innerHTML = "";
    lists.innerHTML = "";
    chatsEl.innerHTML = "";
}

function loadFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
        try {
            process(JSON.parse(reader.result));
            renderAll();
        } catch {}
    };
    reader.readAsText(file);
}

function process(data) {
    if (data.relationships_followers) {
        data.relationships_followers.forEach(u =>
            followers.add(u.string_list_data[0].value)
        );
    }
    if (data.relationships_following) {
        data.relationships_following.forEach(u =>
            following.add(u.string_list_data[0].value)
        );
    }
    if (data.messages && data.participants) {
        data.messages.forEach(m => {
            chatStats[m.sender_name] = (chatStats[m.sender_name] || 0) + 1;
            messagesTimeline.push(m.timestamp_ms);
        });
        renderChat(data.participants, data.messages);
    }
}

function renderAll() {
    renderDashboard();
    renderLists();
}

function renderDashboard() {
    const notFollowingBack = [...following].filter(x => !followers.has(x));
    const topPerson = Object.entries(chatStats).sort((a,b)=>b[1]-a[1])[0];

    dashboard.innerHTML = `
    <div class="card">
        <div class="title">üìä Resumen General</div>
        <div class="row"><span>Seguidores</span><span>${followers.size}</span></div>
        <div class="row"><span>Siguiendo</span><span>${following.size}</span></div>
        <div class="row"><span>No te siguen</span><span>${notFollowingBack.length}</span></div>
        <div class="row"><span>Personas con chat</span><span>${Object.keys(chatStats).length}</span></div>
        <div class="row"><span>Top contacto</span><span>${topPerson ? topPerson[0] : "‚Äî"}</span></div>
    </div>
    `;
}

function renderLists() {
    const notFollowingBack = [...following].filter(x => !followers.has(x));

    lists.innerHTML = `
    <div class="card searchable">
        <div class="title">‚ùå No te siguen</div>
        ${notFollowingBack.slice(0,100).map(n => `<div>${n}</div>`).join("")}
    </div>

    <div class="card searchable">
        <div class="title">üî• Top contactos</div>
        ${Object.entries(chatStats)
            .sort((a,b)=>b[1]-a[1])
            .slice(0,20)
            .map(([n,c]) => `<div>${n} (${c})</div>`).join("")}
    </div>
    `;
}

function renderChat(participants, messages) {
    const card = document.createElement("div");
    card.className = "card searchable";
    card.innerHTML = `
        <div class="title">üí¨ Chat</div>
        <div class="small">${participants.map(p=>p.name).join(", ")}</div>
    `;

    messages.slice(0,40).forEach(m => {
        card.innerHTML += `
            <div class="chat">
                <strong>${m.sender_name}</strong>: ${m.content || "[Media]"}
            </div>
        `;
    });

    chatsEl.appendChild(card);
}
</script>

</body>
</html>
